### ä¸‰ Forms

#### 1. Forms and CSRF

ç°åœ¨æˆ‘ä»¬æƒ³è¦åœ¨ `jobs` ç›®å½•ä¸‹å¢åŠ ä¸€ä¸ª `create` é¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦å°†æ–°çš„è·¯ç”±æ”¾åœ¨ `/jobs/{id}`è·¯ç”±å‰ã€‚å¦‚æœæ–°çš„è·¯ç”±åœ¨å…¶åï¼Œé‚£ä¹ˆå³ä¾¿ç”¨æˆ·è¯·æ±‚äº† `/jobs/create`ä¹Ÿä¼šè¢« `/jobs/{id}` æ¥ç®¡ã€‚

```shell
Route::get("/jobs/create", function ($id)  {

    dd("Create a Job");

    return view('jobs.create', ["job" => $job]);
});

Route::get("/jobs/{id}", function ($id)  {
    $job = Job::find($id);
    //dd($job);

    return view('jobs.show', ["job" => $job]);
});
```

åœ¨ `views` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `jobs` ç›®å½•ï¼Œ

- å°† `/jobs` è·¯ç”±é¡µé¢åæ”¹ä¸º `index.blade.php`
- å°†`/jobs/create` è·¯ç”±é¡µé¢æ”¹åä¸º `create.blade.php`
- å°†`/jobs/{id}`è·¯ç”±é¡µé¢æ”¹åä¸º `show.blade.php`

```php
Route::get('/jobs', function () {
	...
    return view('jobs.index', [
        'jobs' => $jobs
        ]
    );
});
Route::get("/jobs/create", function ()  {
	...
    return view('job.create', ["job" => $job]);
});
Route::get("/jobs/{id}", function ($id)  {
	...
    return view('job.show', ["job" => $job]);
});
```



åœ¨ç½‘é¡µ https://tailwindui.com/components/application-ui/forms/form-layouts ä¸Šè·å–è¡¨å• css æ ·å¼ï¼Œä¿®æ”¹åæ ¼å¼å¦‚ä¸‹ï¼š

```html
<title>Job</title>

<x-layout> 
    <x-slot:heading>
        Create Job
    </x-slot:heading>

<form method='POST' action="/jobs" >
    @csrf
    <div class="space-y-12">
      <div class="border-b border-gray-900/10 pb-12">
        <h2 class="text-base font-semibold leading-7 text-gray-900">Create a Job</h2>
        <p class="mt-1 text-sm leading-6 text-gray-600">We need a handful details from you.</p>
  
        <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
            <div class="sm:col-span-4">
                <label for="username" class="block text-sm font-medium leading-6 text-gray-900">Title</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            <input type="text" name="title" id="title" class="block flex-1 border-0 bg-transparent py-1.5 pl-3 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6" placeholder="WXG">
                        </div>
                    </div>
            </div>

            <div class="sm:col-span-4">
                <label for="username" class="block text-sm font-medium leading-6 text-gray-900">Salary</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            <input type="text" name="salary" id="salary" class="block flex-1 border-0 bg-transparent py-1.5 pl-3 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6" placeholder="50,000 per month">
                        </div>
                    </div>
            </div>
  
        </div>
    </div>     
    </div>
 
    <div class="mt-6 flex items-center justify-end gap-x-6">
      <button type="button" class="text-sm font-semibold leading-6 text-gray-900">Cancel</button>
      <button type="submit" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Save</button>
    </div>
  </form>
 
</x-layout>
```

å½“ç‚¹å‡» `Save`æ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ `/jobs` å‘é€ `POST` è¯·æ±‚ã€‚

`@csrf` ä¼šè®© laravel ç”Ÿæˆä¸€ä¸ªéšå¼çš„ tokenï¼Œç”¨æ¥æ–¹å¼è·¨ç«™ç‚¹æ”»å‡»ã€‚

å¯ä»¥å¢åŠ ä¸‹é¢çš„ route ç”¨æ¥æ•è·ç”¨æˆ·çš„è¯·æ±‚ï¼š

```php
Route::post('/jobs', function() {
    dd(request()->all());
    return view();
});
```

`dd(request('salary'));` å¯ä»¥åªç”¨æ¥æŸ¥çœ‹ `salary` å­—æ®µ



```php
Route::post('/jobs', function() {   
    Job::create([
        'title' => request('title'), 
        'salary'=> request('salary'),
        'employer_id' => 1
    ]);

    return redirect('/jobs');
});
```

ä¿®æ”¹ *app/Models/Job.php*

```php
protected $fillable = ['employer_id', 'title', 'salary'];
```

`lastest()`å°†æ•°æ®åº“æŒ‰ç…§è®°å½•çš„ **åˆ›å»ºæ—¥æœŸ** é™åºæ’åºï¼š

```php
Route::get('/jobs', function () {
    $jobs = Job::with('employer')->latest()->paginate(3);
    return view('jobs.index', [
        'jobs' => $jobs
        ]
    );
});
```



#### 2. Validate

ç°åœ¨æˆ‘ä»¬åœ¨ `header` éƒ¨åˆ†å¢åŠ ä¸€ä¸ª `button` ç”¨æ¥åœ¨æµè§ˆ `jobs` å¯ä»¥æ–°å¢ä¸€ä¸ª `job`

```html
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900"> {{$heading}} </h1>
        <a href="/jobs/create">Create Job</a>
    </div>
</header>
```

![1.png](https://s2.loli.net/2024/06/04/PGrelhYZvjU1Hio.png)

å¢åŠ æ ·å¼ï¼š` sm:flex sm:justify-between`

```css
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8 sm:flex sm:justify-between">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900"> {{$heading}} </h1>
        <a href="/jobs/create">Create Job</a>
    </div>
</header>
```

![2.png](https://s2.loli.net/2024/06/04/3s49klJEDNYpIbo.png)

å¤åˆ¶å°†ç”¨æ¥åˆ†é¡µçš„ next æŒ‰é’®çš„æ ·å¼ :

```css
`relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 leading-5 rounded-md hover:text-gray-500 focus:outline-none focus:ring ring-gray-300 focus:border-blue-300 active:bg-gray-100 active:text-gray-700 transition ease-in-out duration-150 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:focus:border-blue-700 dark:active:bg-gray-700 dark:active:text-gray-300
```

`next` æŒ‰é’®é»˜è®¤ç”¨çš„æ˜¯ `tailwind`ï¼Œå¯¹åº”é¡µé¢æ–‡ä»¶ä¸º `resources/views/vendor/pagination/tailwind.blade.php`

![3.png](https://s2.loli.net/2024/06/04/BhwjgXkLs16C5OT.png)

ä¸ºäº†æ–¹ä¾¿å¤ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªæ ·å¼å•ç‹¬é¢†å‡ºæ¥ï¼Œä½œä¸ºä¸€ä¸ª blade æ–‡ä»¶ï¼š

```php
<a {{ $attributes->merge(['class' => 'relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 leading-5 rounded-md hover:text-gray-500 focus:outline-none focus:ring ring-gray-300 focus:border-blue-300 active:bg-gray-100 active:text-gray-700 transition ease-in-out duration-150 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:focus:border-blue-700 dark:active:bg-gray-700 dark:active:text-gray-300' ])  }}> {{ $slot }} </a>
```

è¿™è¡¨ç¤ºå°†é¡µé¢åŸæœ¬çš„ class å’Œ ä¸Šé¢è¿™ä¸€ä¸² class æ ·å¼èåˆèµ·æ¥ã€‚



å¢åŠ  `required`å°†é˜²æ­¢ç”¨æˆ·ä¸å¡«ä»»ä½•å†…å®¹æäº¤

```php
<input type="text" name="title" id="title" class="block flex-1 border-0 bg-transparent py-1.5 pl-3 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6" placeholder="WXG" required>
```

å°† `/jobs`çš„ `route` ä¿®æ”¹ä¸ºï¼š

```php
Route::post('/jobs', function() {   

    request()->validate([
       'title'  => ['required', 'min: 3'],#æœ€å°‘é•¿åº¦ä¸º3
       'salary' => ['required']
    ]);

    Job::create([
        'title' => request('title'), 
        'salary'=> request('salary'),
        'employer_id' => 1
    ]);

    return redirect('/jobs');
});
```

ä¿®æ”¹ `resource/views/jobs/create.blade.php`ï¼š

```php
<div class="mt-10">
    @if($errors->any())
        <ul>
            @foreach($errors->all() as $error)
                <li class="text-red-500 italic">{{ $error }}</li>
            @endforeach
        </ul>
    @endif
</div>
```

æ•ˆæœå¦‚ä¸‹ï¼š

![4.png](https://s2.loli.net/2024/06/04/dYXNA95fb3GmkLO.png)



ç°åœ¨æˆ‘ä»¬æƒ³å°†é”™è¯¯æç¤ºæ”¾åœ¨å¯¹åº”è¡¨å•çš„æ­£ä¸‹æ–¹ï¼š

```php
<div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
	<input type="text" name="salary" id="salary" class="block flex-1 border-0 bg-transparent py-1.5 pl-3 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6" placeholder="50,000 per month">
</div>

@error('salary')
	<p class='text-xs text-red-500 font-semibold mt-1'>{{ $message  }}</p>
@enderror
```

æ•ˆæœå¦‚ä¸‹ï¼š

![1.png](https://s2.loli.net/2024/06/04/qrgjcl641uz87Zv.png)



https://learnku.com/docs/laravel/10.x/validation/14856#189a36 æ›´å¤šçš„éªŒè¯è§„åˆ™ã€‚



#### 3. Resource

ç°åœ¨æˆ‘ä»¬æƒ³åœ¨æ¯ä¸ªå·¥ä½œçš„è¯¦æƒ…é¡µé¢å¢åŠ ä¸€ä¸ª `edit` æŒ‰é’®ï¼Œç”¨æ¥ä¿®æ”¹å·¥ä½œç›¸å…³ä¿¡æ¯ã€‚

å¢åŠ  `route`ï¼š

```php
Route::get("/jobs/{id}/edit", function ($id)  {
    $job = Job::find($id);

    return view('jobs.edit', ["job" => $job]);
});
```

åœ¨ `show.blade.php` ä¸­å¢åŠ  button:

```php
<p class="mt-6">
    <x-button href='/jobs/{{ $job->id }}/edit'> Edit Job  </x-button>
</p>
```

`edit.blade.php`

```php
<div class="...">
    <input 
    type="text" 
    name="title" 
    id="title" 
    class="..." 
    placeholder="WXG" 
    value="{{ $job->title }}"
    required>
</div>
	
<div class="...">
    <input 
    type="text" 
    name="salary" 
    id="salary" 
    class="..." 
    placeholder="50,000 per month" 
    value="{{ $job->salary }}"
    required>
</div>
```



å¯¹äºä¿®æ”¹å’Œåˆ é™¤,å¢åŠ ä¸¤æ¡ route:

```php
Route::patch('/jobs/{id}', function($id) {   

    request()->validate([
       'title'  => ['required', 'min: 3'],
       'salary' => ['required']
    ]);

    $job = Job::findOrFail($id);

    Job::update([
        'title' => request('title'), 
        'salary'=> request('salary'),
    ]);

    return redirect('/jobs/' . $job->id);
});

Route::delete('/jobs/{id}', function($id) {   

    Job::findOrFail($id)->delete();

    return redirect('/jobs/');
});
```

`find`å‡½æ•°åœ¨æ‰¾ä¸åˆ° `id` æ—¶è¿”å› `null`ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ç”¨ `findOrFail`å‡½æ•°ã€‚

`@method('PATCH')` ç”¨æ¥å‘Šè¯‰ `Laravel` çœŸæ­£è¯·æ±‚æ˜¯ `PATCH`

```php
<form method='POST' action="/jobs/{{ $job->id }}" >
    @csrf
    @method('PATCH')
    <div class="...">
    	<a href="/jobs/{{ $job->id }}" class="...">Cancel</button>
   	 	<button type="submit" class="...">Update</button>
    </div>
</form>
```



å¢åŠ ä¸€ä¸ª buttonï¼Œç”¨æ¥åˆ é™¤ï¼š

1. `flex`ï¼šè¿™ä¸ªç±»ç»™å…ƒç´ åº”ç”¨äº† CSS çš„ `display: flex;` å±æ€§ã€‚è¿™ä½¿å¾—è¯¥å…ƒç´ æˆä¸ºä¸€ä¸ªå¼¹æ€§å®¹å™¨ï¼Œå…è®¸å…¶å­å…ƒç´ ä»¥çµæ´»çš„æ–¹å¼å¸ƒå±€ã€‚
2. `items-center`ï¼šè¿™ä¸ªç±»é€šå¸¸ç»™å…ƒç´ åº”ç”¨äº† CSS çš„ `align-items: center;` å±æ€§ã€‚è¿™ä½¿å¾—å¼¹æ€§å®¹å™¨çš„å­å…ƒç´ æ²¿ç€äº¤å‰è½´ï¼ˆå¦‚æœä¸»è½´æ˜¯æ°´å¹³çš„ï¼Œåˆ™äº¤å‰è½´æ˜¯å‚ç›´çš„ï¼‰å±…ä¸­å¯¹é½ã€‚
3. `gap-x-6`ï¼šè¿™ä¸ªç±»é€šå¸¸ç»™å¼¹æ€§å®¹å™¨çš„å­å…ƒç´ ä¹‹é—´åº”ç”¨ä¸€ä¸ªæ°´å¹³é—´éš”ã€‚é—´éš”çš„ç¡®åˆ‡å€¼å–å†³äºæ‰€ä½¿ç”¨çš„ CSS æ¡†æ¶ã€‚ä¾‹å¦‚ï¼Œåœ¨ Tailwind CSS ä¸­ï¼Œ`gap-x-6` ä¼šåº”ç”¨ä¸€ä¸ª 1.5remï¼ˆ24pxï¼‰çš„æ°´å¹³é—´éš”ã€‚
4. `justify-end`ï¼šå½“åº”ç”¨äºå¼¹æ€§å®¹å™¨æ—¶ï¼Œ`justify-end` ä¼šä½¿å­å…ƒç´ æ²¿ç€ä¸»è½´ï¼ˆé€šå¸¸æ˜¯æ°´å¹³è½´ï¼‰çš„æœ«ç«¯å¯¹é½ã€‚å¦‚æœä¸»è½´æ˜¯æ°´å¹³çš„ï¼Œé‚£ä¹ˆå­å…ƒç´ å°†ä¼šé å³å¯¹é½ï¼›å¦‚æœä¸»è½´æ˜¯å‚ç›´çš„ï¼Œé‚£ä¹ˆå­å…ƒç´ å°†ä¼šé ä¸‹å¯¹é½ã€‚
5. `justify-between` ï¼šå½“åº”ç”¨äºå¼¹æ€§å®¹å™¨æ—¶ï¼Œ`justify-between` ä¼šä½¿å­å…ƒç´ æ²¿ç€ä¸»è½´ï¼ˆé€šå¸¸æ˜¯æ°´å¹³è½´ï¼‰å‡åŒ€åˆ†å¸ƒï¼Œç¬¬ä¸€ä¸ªå­å…ƒç´ é è¿‘èµ·å§‹è¾¹ç¼˜ï¼Œæœ€åä¸€ä¸ªå­å…ƒç´ é è¿‘ç»“æŸè¾¹ç¼˜ï¼Œè€Œå®ƒä»¬ä¹‹é—´çš„å­å…ƒç´ åˆ™å‡åŒ€åˆ†å¸ƒã€‚å¦‚æœä¸»è½´æ˜¯æ°´å¹³çš„ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå­å…ƒç´ å°†ä¼šé å·¦å¯¹é½ï¼Œæœ€åä¸€ä¸ªå­å…ƒç´ å°†ä¼šé å³å¯¹é½ï¼Œå®ƒä»¬ä¹‹é—´çš„å­å…ƒç´ åˆ™å‡åŒ€åˆ†å¸ƒã€‚

```html
<div class="mt-6 flex items-center justify-between gap-x-6">

    <div>
        <button form='delete-form' class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Delete</button>
    </div>            

    <div class="flex item-center gap-x-6">
        <a href="/jobs/{{ $job->id }}" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
            Cancel
        </a>

        <div>
            <button type="submit" class="rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                Update
            </button>
        </div>
    </div>

</div>
```

æ•ˆæœå¦‚ä¸‹ï¼š

![2.png](https://s2.loli.net/2024/06/04/nivgLHyIlBk2fr5.png)

ä¸€ä¸ªè¡¨å•ä¸­æ— æ³•åµŒå¥—å¦ä¸€ä¸ªè¡¨å•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€åšä¸€äº›ç‰¹æ®Šå¤„ç†ï¼š

```html
<div>
    <button form='delete-form' class="...">Delete</button>
</div>   

<form method="POST" action="/jobs/{{ $job->id }}" id='delete-form' class="hidden">
@method('DELETE')
@csrf

</form>
```



#### 4. Routes Reloaded

ä¿®æ”¹æˆ‘ä»¬çš„ `route` ï¼š

å°†ï¼š

```php
Route::patch('/jobs/{id}', function($id) 
```

ä¿®æ”¹ä¸ºï¼š

```php
Route::patch('/jobs/{job}', function(Job $job) 
```

è¿™ä¼šå‘Šè¯‰ Laravel å¸®æˆ‘ä»¬æ•æ‰ `Job` ç±»å‹çš„ `job`ã€‚



é€šè¿‡ controller è®© route æ›´åŠ ç®€æ´

```shell

â•°â”€â—‹ php artisan make:controller

 â”Œ What should the controller be named? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ JobController                                                â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 â”Œ Which type of controller would you like? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Empty                                                        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   INFO  Controller [app/Http/Controllers/JobController.php] created successfully.
```

```php
Route::view('/', 'about');
Route::view('/contact', 'contact');


Route::get('/jobs', [JobController::class, 'index']);
Route::post('/jobs', [JobController::class, 'store']);
Route::patch('/jobs/{job}', [JobController::class, 'update']);
Route::delete('/jobs/{job}', [JobController::class, 'destory']);
Route::get("/jobs/{job}", [JobController::class, 'show']);
Route::get("/jobs/{job}/edit", [JobController::class, 'edit']);
Route::get("/jobs/create", [JobController::class, 'create']);
```

`app/Http/Controllers/JobController.php`

```php
<?php

namespace App\Http\Controllers;

use App\Models\Job;
use Illuminate\Http\Request;

class JobController extends Controller
{
    public function index()
    {
        $jobs = Job::with('employer')->latest()->paginate(3);

        return view('jobs.index', [
            'jobs' => $jobs
            ]
        );
    }

    public function create()
    {
        return view('jobs.create');
        
    }

    public function show(Job $job)
    {
        return view('jobs.show', ["job" => $job]);
    }

    public function store()
    {
        request()->validate([
            'title'  => ['required', 'min: 3'],
            'salary' => ['required']
         ]);
     
         Job::create([
             'title' => request('title'), 
             'salary'=> request('salary'),
             'employer_id' => 1
         ]);
     
         return redirect('/jobs');
    }

    public function edit(Job $job)
    {
        return view('jobs.edit', ["job" => $job]);
    }

    public function update(Job $job)
    {
        request()->validate([
            'title'  => ['required', 'min: 3'],
            'salary' => ['required']
         ]);
     
         $job->update([
             'title' => request('title'), 
             'salary'=> request('salary'),
         ]);
     
         return redirect("/jobs/" . $job->id);
    }

    public function destory(Job $job)
    {
        $job->delete();
        return redirect('/jobs');
    }
}
```



åˆ—å‡ºæ‰€æœ‰çš„ routesï¼š

```shell

â•­â”€root at VM-4-14-ubuntu in ~/php/test 24-06-05 - 1:51:48
â•°â”€â—‹ php artisan route:list

  GET|HEAD   / .....................................................................................
  GET|HEAD   contact ................................................................................
  GET|HEAD   jobs .............................................................. JobController@index
  POST       jobs .............................................................. JobController@store
  GET|HEAD   jobs/create ....................................................... JobController@create
  PATCH      jobs/{job} ........................................................ JobController@update
  DELETE     jobs/{job} ........................................................ JobController@destory
  GET|HEAD   jobs/{job} ........................................................ JobController@show
  GET|HEAD   jobs/{job}/edit ................................................... JobController@edit
  GET|HEAD   up .................................................................

                                                                                           Showing [10] routes

â•­â”€root at VM-4-14-ubuntu in ~/php/test 24-06-05 - 1:52:01
â•°â”€â—‹ php artisan route:list --except-vendor

  GET|HEAD   / ...........................................................................
  GET|HEAD   contact ......................................................................
  GET|HEAD   jobs ................................................................. JobController@index
  POST       jobs ................................................................. JobController@store
  GET|HEAD   jobs/create .......................................................... JobController@create
  PATCH      jobs/{job} ........................................................... JobController@update
  DELETE     jobs/{job} ........................................................... JobController@destory
  GET|HEAD   jobs/{job} ........................................................... JobController@show
  GET|HEAD   jobs/{job}/edit ...................................................... JobController@edit

                                                                                   Showing [9] routes
```



æ›´åŠ ç®€åŒ–ï¼š

```php
Route::controller(JobController::class)->group(function(){
    Route::get('/jobs', 'index');
    Route::post('/jobs', 'store');
    Route::patch('/jobs/{job}', 'update');
    Route::delete('/jobs/{job}', 'destory');
    Route::get("/jobs/{job}", 'show');
    Route::get("/jobs/{job}/edit", 'edit');
    Route::get("/jobs/create", 'create');
});
```





### å›› Authentication

#### 1. Starter Kits, Breeze and Middleware

##### ä½¿ç”¨ breeze æ„å»ºç™»é™†æ³¨å†Œé¡µé¢ 

å¦‚æœç›´æ¥æ‰§è¡Œ `laravel new [project_name]` ä¸èƒ½è¿›å…¥ starter kit çš„é€‰æ‹©ç•Œé¢ 

![3.png](https://s2.loli.net/2024/06/05/3WnEImlaYs75DiK.png)

å¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼š

```shell
$laravel new app
$composer require laravel/breeze --dev
php artisan migrate
npm install
npm run dev
```

é»˜è®¤æ˜¯ sqlite æ•°æ®åº“ï¼Œæˆ‘ä»¬ä¿®æ”¹ .env æ–‡ä»¶ï¼Œå°†æ•°æ®åº“æ›´æ”¹ä¸º MySQLï¼Œå¹¶é‡æ–°æ‰§è¡Œ migrate å‘½ä»¤



å½“æˆ‘ä»¬åœ¨æ²¡æœ‰ç™»é™†çš„çŠ¶æ€ä¸‹è¯•å›¾è®¿é—® dashboard æ—¶ï¼Œæ˜¯æ²¡æœ‰æƒé™çš„ï¼Œé¡µé¢ä¼šè¢«é‡å®šå‘åˆ°ç™»é™†é¡µé¢ï¼š

```php
Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');
```



##### ä½¿ç”¨ blade é‡æ„è¡¨å•

é‡æ„ `form` è¡¨å•çš„ `label`ï¼Œ`input`ï¼Œ`error` å’Œ `button`ï¼š

![4.png](https://s2.loli.net/2024/06/05/vky5c17MAxUdZrT.png)

*resources/views/components/form-button.blade.php*

```html
<button {{ $attributes->merge(['class' => 'rounded-md px-3 py-2 text-sm font-semibold text-white shadow-sm  focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2']) }} > 
    {{ $slot }}
</button>
```

*resources/views/components/form-cancel.blade.php*

```html
<a {{ $attributes->merge(['class' => 'rounded-md px-3 py-2 text-sm font-semibold text-white shadow-sm  focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2']) }} > 
    {{ $slot }}
</a>
```

*resources/views/components/form-error.blade.php*

```php
@props(['name'])

@error($name)
    <p class='text-xs text-red-500 font-semibold mt-1'>{{ $message  }}</p>
@enderror
```

*resources/views/components/form-input.blade.php*

```html
<div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
    <input 
        {{ $attributes->merge(['class' => "block flex-1 border-0 bg-transparent py-1.5 pl-3 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6"]) }} 
    >
</div>
```

*resources/views/components/form-label.blade.php*

```php
<label {{ $attributes->merge(['class' => 'block text-sm font-medium leading-6 text-gray-900'])  }}> {{ $slot  }} </label>
```

*resources/views/jobs/create.blade.php*

```php
<title>Job</title>

<x-layout> 
    <x-slot:heading>
        Create Job
    </x-slot:heading>

<form method='POST' action="/jobs" >
    @csrf
    
    <div class="space-y-12">
      <div class="border-b border-gray-900/10 pb-12">
        <h2 class="text-base font-semibold leading-7 text-gray-900">Create a Job</h2>
        <p class="mt-1 text-sm leading-6 text-gray-600">We need a handful details from you.</p>
  
        <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
            <div class="sm:col-span-4">
                <x-form-label for="title">Title</x-form-label>
                    <div class="mt-2">

                        <x-form-input type="text" name="title" id="title" placeholder="WXG" required/>
                        <x-form-error name='title'/>

                    </div>
            </div>

            <div class="sm:col-span-4">
                <x-form-label for="salary">Salary</x-form-label>
                    
                    <div class="mt-2">
                      
                        <x-form-input type="text" name="salary" id="salary" placeholder="50,000 per month" required/>
                        <x-form-error name='salary'/>
                    
                    </div>
            </div>
        </div>

    
    </div>
    </div>
  
    <div class="mt-6 flex items-center justify-end gap-x-6">
        <x-form-cancel href="/jobs" class="bg-gray-600 hover:bg-gray-500 focus-visible:outline-indigo-500">
            Cancel
        </x-form-cancel>
        
        <x-form-button type="submit" class="bg-indigo-600 hover:bg-indigo-500 focus-visible:outline-indigo-600" >
            Save
        </x-form-button>
    </div>
  </form>
  

</x-layout>
```

*resources/views/jobs/edit.blade.php*

```php
<title>JOB</title> 

<x-layout > 
    <x-slot:heading>
        Edit Job: {{ $job->title }}
    </x-slot:heading>


    <form method='POST' action="/jobs/{{ $job->id }}">
        @csrf
        @method('PATCH')

        <div class="space-y-12">
          <div class="border-b border-gray-900/10 pb-12">
            <h2 class="text-base font-semibold leading-7 text-gray-900">Create a Job</h2>
            <p class="mt-1 text-sm leading-6 text-gray-600">We need a handful details from you.</p>
      
            <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                <div class="sm:col-span-4">

                    <x-form-label for="title">Title</x-form-label>
                        
                    <div class="mt-2">

                            <x-form-input 
                                type="text" 
                                name="title" 
                                id="title"
                                placeholder="WXG" 
                                value="{{ $job->title }}"
                                required/>
                            
                            <x-form-error name='title'/>
    
                        </div>
                </div>
    
                <div class="sm:col-span-4">

                    <x-form-label for="salary">Salary</x-form-label>
   
                        <div class="mt-2">
                          
                            <x-form-input 
                                type="text" 
                                name="salary" 
                                id="salary"
                                placeholder="50,000 per month" 
                                value="{{ $job->salary }}"
                                required/>
                            
                            <x-form-error name='salary'/>
                        
                        </div>
                </div>
            </div>
    
        
        </div>
        </div>
      
        <div class="mt-6 flex items-center justify-between gap-x-6">
            
            <div>
                <x-form-button form='delete-form' class='bg-red-600 hover:bg-red-500 focus-visible:outline-indigo-600'>
                    Delete
                </x-form-button>
            </div>

            <div class="flex item-center gap-x-6">

                <x-form-cancel href="/jobs/{{ $job->id }}" class='bg-indigo-600 hover:bg-indigo-500 focus-visible:outline-indigo-600'>
                    Cancel
                </x-form-cancel>
                
                <div>
                    <x-form-button type="submit" class='bg-green-600 hover:bg-green-500 focus-visible:outline-indigo-600'>
                        Update
                    </x-form-button>
                </div>


            </div>

        </div>
      </form>

      <form method="POST" action="/jobs/{{ $job->id }}" id='delete-form' class="hidden">
        @method('DELETE')
        @csrf

      </form>

</x-layout>
```



#### 2. Make a Login and Registration System

```shell
â•­â”€root at VM-4-14-ubuntu in ~/php/test 24-06-05 - 14:56:47
â•°â”€â—‹ php artisan make:controller

 â”Œ What should the controller be named? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ RegisterUserController                                       â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 â”Œ Which type of controller would you like? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Empty                                                        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   INFO  Controller [app/Http/Controllers/RegisterUserController.php] created successfully.
```

å¢åŠ  routeï¼š

```php
Route::controller(RegisterUserController::class)->group(function(){
    Route::get('/register', 'create');
    Route::post('/register', 'store');
});
```

*app/Http/Controllers/RegisterUserController.php*

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class RegisterUserController extends Controller
{
    public function create()
    {
        return view('auth.register');  
    }

    public function store() 
    {
        dd(request()->all());        
    }
}
```

*resources/views/auth/register.blade.php*

```php
<title>Job</title>

<x-layout> 
    <x-slot:heading>
        Register
    </x-slot:heading>

<form method='POST' action="/register" >
    @csrf
    
    <div class="space-y-12">
      <div class="border-b border-gray-900/10 pb-12">
  
        <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">

            <div class="sm:col-span-4">
                <x-form-label for="first_name">First Name</x-form-label>
                    <div class="mt-2">

                        <x-form-input type="text" name="first_name" id="first_name" required/>
                        <x-form-error name='first_name'/>

                    </div>
            </div>

            <div class="sm:col-span-4">
                <x-form-label for="last_name">last name</x-form-label>
                    
                    <div class="mt-2">
                      
                        <x-form-input type="text" name="last_name" id="last_name" required/>
                        <x-form-error name='last_name'/>
                    
                    </div>
            </div>

            <div class="sm:col-span-4">
                <x-form-label for="email">Email</x-form-label>
                    
                    <div class="mt-2">
                        <x-form-input type="email" name="email" id="email" required/>
                        <x-form-error name='email'/>
                    </div>
            </div>


            <div class="sm:col-span-4">
                <x-form-label for="password">password</x-form-label>
                    
                    <div class="mt-2">
                      
                        <x-form-input type="password" name="password" id="password" required/>
                        <x-form-error name='password'/>
                    
                    </div>
            </div>

            <div class="sm:col-span-4">
                <x-form-label for="password_confirm">password confirm</x-form-label>
                    
                    <div class="mt-2">
                      
                        <x-form-input type="password" name="password_confirm" id="password_confirm" required/>
                        <x-form-error name='password_confirm'/>
                    
                    </div>
            </div>
        </div>

    </div>
    </div>
  
    <div class="mt-6 flex items-center justify-end gap-x-6">
        <x-form-cancel href="/login" class="bg-gray-600 hover:bg-gray-500 focus-visible:outline-indigo-500">
            Cancel
        </x-form-cancel>
        
        <x-form-button type="submit" class="bg-indigo-600 hover:bg-indigo-500 focus-visible:outline-indigo-600" >
            Save
        </x-form-button>
    </div>
  </form>
  

</x-layout>
```



```php
â”€root at VM-4-14-ubuntu in ~/php/test 24-06-05 - 15:49:21
â•°â”€â—‹ php artisan make:controller

 â”Œ What should the controller be named? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ SessionController                                            â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 â”Œ Which type of controller would you like? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Empty                                                        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   INFO  Controller [app/Http/Controllers/SessionController.php] created successfully.
```

route:

```php
```



`Login` å’Œ `Register` æŒ‰é’®åªéœ€è¦åœ¨ç”¨æˆ·æœªç™»å½•æ—¶æ˜¾ç¤ºå³å¯ã€‚

- `@auth...@endauth` è¡¨ç¤ºç»è¿‡è®¤è¯æ—¶çš„æ‰§è¡Œæµ
- `@guest...@endguest` è¡¨ç¤ºæœªç»è®¤è¯çš„æ‰§è¡Œæµ

```php
<div class="hidden md:block">
    <div class="ml-4 flex items-center md:ml-6">

    @guest
    <x-nav-link href="/login" > Login </x-nav-link>
    <x-nav-link href="/register" > Regiter </x-nav-link>
    @endguest

    </div>
</div>
```



`Password::min(6)->letter()->number()` è¡¨ç¤ºå¯†ç é•¿åº¦è‡³å°‘ä¸º 6ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—ã€‚

`confirmed` è¡¨ç¤ºä¼šå°† `password` å’Œ `password_confirmation` å­—æ®µè¿›è¡Œå¯¹æ¯”ä¸€è‡´ã€‚

```php
request()->validate([
    'first_name' => ['required'],
    'last_name'  => ['required'],
    'email'      => ['required', 'email'],
    'password'   => ['required', Password::min(6)->letters()->numbers(), 'confirmed']
]);
```



```php
<div class="sm:col-span-4">
    <x-form-label for="password">password</x-form-label>
        
        <div class="mt-2">
            
            <x-form-input type="password" name="password" id="password" required/>
            <x-form-error name='password'/>
        
        </div>
</div>

<div class="sm:col-span-4">
    <x-form-label for="password_confirm">confirm password</x-form-label>
        
        <div class="mt-2">
            
            <x-form-input type="password" name="password_confirmation" id="password_confirmation" required/>
            <x-form-error name='password_confirmation'/>
        
        </div>
</div>
```

å®Œæ•´æ ¼å¼å¦‚ä¸‹ï¼š

```php
public function store() 
{
    $attrs = request()->validate([
        'first_name' => ['required'],
        'last_name'  => ['required'],
        'email'      => ['required', 'email'],
        'password'   => ['required', Password::min(6)->letters()->numbers(), 'confirmed']
    ]);

    $user = User::create($attrs);
    Auth::login($user); 

    return redirect('/jobs');
}
```

*/app/Models/User.php*

```php
protected function casts(): array
{
    return [
        'email_verified_at' => 'datetime',
        'password' => 'hashed',
    ];
}
```

è¿™ä¼šå°†æˆ‘ä»¬æäº¤çš„å¯†ç è¿›è¡Œå“ˆå¸Œï¼Œå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚

å¯åŠ¨ tinkerï¼š

```shell
> $user = new App\Models\User;
= App\Models\User {#5009}

> $user->password = 'password';
= "password"

> $user->password;
= "$2y$12$Fip6nkiLOvYV6dUOpMjDwOszkZs387EzcBSF3YhwNBmVYlaXq9FLO"
```



è¾“å…¥æ¡†é‡Œè®°å½•ä¸Šä¸€æ¬¡é”™è¯¯è¾“å…¥çš„å€¼ï¼š

```html
 <x-form-input type="email" ... value="old('email')" .../>
```

æ³¨æ„ä¸Šé¢çš„å†™æ³•æ˜¯ä¸å¯¹çš„ï¼Œ`"old('email')"` ä¼šè¢«å½“ä½œå­—ç¬¦ä¸²ï¼Œè€Œéå‡½æ•°ï¼Œæ­£ç¡®å†™æ³•ï¼š

```php
<x-form-input type="email" ... :value="old('email')" .../>
<x-form-input type="email" ... value="{{old('email')}}" .../>
```



#### 3. Authorization

##### `is`

`$model->is()` åˆ¤æ–­ä¸¤ä¸ª `model` çš„ `id` æ˜¯å¦ä¸€è‡´ï¼›`isNot` åˆ™æ­£å¥½ç›¸åã€‚

```php
$job->employer->user->isNot(Auth::user())
```

ç¼–è¾‘æƒé™ï¼š

1. ç™»é™†ç”¨æˆ·
2. `employer id` å’Œ `user id` åŒ¹é…

```php
public function edit(Job $job)
{
    // 1. éªŒè¯æ˜¯å¦ç™»é™†
    if( Auth::guest() )
    	return redirect('/login');
    // 2. éªŒè¯æ­£åœ¨ç¼–è¾‘çš„ Job æ‰€å±çš„ employer id å’Œç™»é™†ç”¨æˆ·çš„ id æ˜¯å¦ä¸€æ ·
    if( $job->employer->user->isNot(Auth::user()) )
    	abort(403);

    return view('jobs.edit', ["job" => $job]);
}
```

##### `Gate`

é€šè¿‡ Gate å®ç°ï¼š

```php
use Illuminate\Support\Facades\Gate;

public function edit(Job $job)
{
    Gate::define('edit-job', function(User $user, Job $job){
        return $job->employer->user->is(Auth::user());
    });
    // 1. éªŒè¯æ˜¯å¦ç™»é™†
    if( Auth::guest() )
        return redirect('/login');

    // 2. éªŒè¯æ­£åœ¨ç¼–è¾‘çš„ Job æ‰€å±çš„ employer id å’Œç™»é™†ç”¨æˆ·çš„ id æ˜¯å¦ä¸€æ ·
    Gate::authorize('edit-job', $job);

    return view('jobs.edit', ["job" => $job]);
}
```

`define` ä¸­å®šä¹‰çš„ `gate name` å’Œ åé¢ `authorize` ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ç›¸åŒã€‚ 

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼š

```php
if( Gate::allows ) {}
if( Gate::denies ) {}
```

æ¥å®šåˆ¶å½“ç”¨æˆ·éªŒè¯é€šè¿‡æˆ–å¤±è´¥åæ‰§è¡Œçš„é€»è¾‘ã€‚

å¦‚æœç”¨æˆ·æ˜¯æ²¡æœ‰ç™»é™†çš„ï¼Œé‚£ä¹ˆ user ä¸º nullï¼Œé‚£ä¹ˆæ¡ä»¶æ€»æ˜¯ false æ— æ³•è¿›å…¥å›è°ƒå‡½æ•°å†…éƒ¨ã€‚

```php
Gate::define('edit-job', function(User $user, Job $job){
    return $job->employer->user->is(Auth::user());
});
```

å¦‚æœæˆ‘ä»¬åœ¨ User å‰åŠ ä¸Š `?` è¡¨ç¤ºå…è®¸è¯¥å‚æ•°ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯å…è®¸ guestï¼Œå¯ä»¥å®šåˆ¶ä¸€äº›å…¶ä»–é€»è¾‘ã€‚

```php
Gate::define('edit-job', function(?User $user, Job $job){
    return $job->employer->user->is(Auth::user());
});
```

`Gate::define` æ˜¯äº‹ä»¶å‘ç”Ÿå‰é¢„å…ˆå®šä¹‰å¥½çš„ï¼Œå› æ­¤å¯ä»¥æ”¾å…¥ `app/Providers/AppServiceProvider.php` è¿™ä¸€å…±äº«åŒºåŸŸå†…ï¼š

```php
public function boot(): void
{
    Model::preventLazyLoading();

    Gate::define('edit-job', function(User $user, Job $job){
        return $job->employer->user->is(Auth::user());
    });
}
```

`edit` å¯ä»¥ä¿®æ”¹ä¸ºï¼š

```php
public function edit(Job $job)
{
    Gate::authorize('edit-job', $job);

    return view('jobs.edit', ["job" => $job]);
}
```



##### `can`

`can`å’Œ`cannot`

```php
public function edit(Job $job)
{
    if( Auth::user()->cannot('edit-job') )
    {
        dd('failure');
    }

    return view('jobs.edit', ["job" => $job]);
}
```

ä¿®æ”¹ `resources/views/jobs/show.blade.php`

å½“å‰ç”¨æˆ·æ‹¥æœ‰ä¿®æ”¹ `job` çš„æƒé™æ—¶ï¼Œæ‰ä¼šæ˜¾ç¤ºè¿™ä¸ª `button`

```php+HTML
@can('edit-job', $job)
<p class="mt-6">
    <x-button href='/jobs/{{ $job->id }}/edit'> Edit Job  </x-button>
</p>
@endcan
```



##### `middleware`

```php
Route::get("/jobs/create", 'create')->middleware(['auth']);
```

å¦‚æœç”¨æˆ·æƒ³è¦ç‚¹å‡»åˆ›å»ºå·¥ä½œï¼Œé‚£ä¹ˆé¦–å…ˆéœ€è¦ç™»é™†ï¼Œ`middleware(['auth']`ä¼šå°†é¡µé¢é‡å®šå‘åˆ° `login` é¡µé¢ï¼Œä½†æ˜¯å¹¶ä¸ä¼šä»¥ `/login` è¿™æ ·çš„å½¢å¼ã€‚æˆ‘ä»¬éœ€è¦ç»™ `/login` è¿™ä¸ªè·¯ç”±æŒ‡å®šä¸€ä¸ªåå­— `login`ã€‚

```php
Route::get('/login', 'create')->name('login');
```

edit æŒ‰é’®éœ€è¦ç™»é™†ï¼Œå¹¶ä¸”æ‹¥æœ‰æƒé™ï¼š

```php
Route::get("/jobs/{job}/edit", 'edit')->middleware(['auth', 'can:edit-job,job']);
```

è¿™æ · controller ä¸­å¯ä»¥å°† can æˆ– gate åˆ å»ï¼š

```php
public function edit(Job $job)
{
    return view('jobs.edit', ["job" => $job]);
}
```



`can` å¯ä»¥ä» `middleware` ä¸­å•æ‹å‡ºæ¥ï¼Œæé«˜å¯è¯»æ€§ï¼š

```php
Route::get("/jobs/{job}/edit", 'edit')
    ->middleware(['auth'])
    ->can('edit-job', 'job');
```



##### `policy`

```shell
â•­â”€root at VM-4-14-ubuntu in ~/php/test 24-06-05 - 23:04:57
â•°â”€â—‹ php artisan make:policy

 â”Œ What should the policy be named? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ JobPolicy                                                    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 â”Œ What model should this policy apply to? (Optional) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Job                                                          â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å°† *app/Providers/AppServiceProvider.php* ä¸­ `gate` çš„æ ¸å¿ƒé€»è¾‘å¤åˆ¶åˆ°åä¸º `edit` çš„ `policy` ä¸­ï¼Œå¹¶å°†å…¶æ³¨é‡Šæ‰ï¼š

*app/Policies/JobPolicy.php*

```php
<?php

namespace App\Policies;

use App\Models\Job;
use App\Models\User;
use Illuminate\Auth\Access\Response;
use Illuminate\Support\Facades\Auth;

class JobPolicy
{
    public function edit(User $user, Job $job): bool 
    {
        return $job->employer->user->is(Auth::user());
    }
}
```

ç°åœ¨ï¼Œä¸åœ¨éœ€è¦åœ¨ can ä¸­ä½¿ç”¨ `edit-job`ï¼š

```php
@can('edit', $job)
<p class="mt-6">
    <x-button href='/jobs/{{ $job->id }}/edit'> Edit Job  </x-button>
</p>
@endcan
    
Route::get("/jobs/{job}/edit", 'edit')
    ->middleware(['auth'])
    ->can('edit', 'job');
```



### äº” Digger Deeper

#### 1. Email

```shell
â•­â”€root at VM-4-14-ubuntu in ~/php/test 24-06-06 - 1:47:55
â•°â”€â—‹ php artisan make:mail

 â”Œ What should the mailable be named? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ JobPosted                                                    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   INFO  Mailable [app/Mail/JobPosted.php] created successfully.

```



`.env` ä¸­é…ç½®é‚®ä»¶çš„å‘é€äººå’Œå‘é€åœ°å€:

```php
MAIL_FROM_ADDRESS="shepardwang@laravel.com"
MAIL_FROM_NAME="Shepard Wang"
```

*app/Mail/JobPosted.php*

```php
public function content(): Content
{
    return new Content(
        view: 'mail.job-posted',
    );
}
```

è®¾ç½®ä¸€ä¸ªç”¨æ¥ test çš„è·¯ç”±:

```php
Route::get('test', function(){
    \Illuminate\Support\Facades\Mail::to('jeffrey@laracasts.com')
    ->send(
        new \App\Mail\JobPosted()
    );
    
    return 'done';
});
```

`storage/logs/laravel.log` è®°å½•ç€å‘å‡ºçš„é‚®ä»¶

```
[2024-06-05 18:20:48] local.DEBUG: From: Shepard Wang <shepardwang@laravel.com>
To: jeffrey@laracasts.com
Subject: Job Posted
MIME-Version: 1.0
Date: Wed, 05 Jun 2024 18:20:48 +0000
Message-ID: <a4c774b70ccd0f8de866fc9bdb20eb73@laravel.com>
Content-Type: text/html; charset=utf-8
Content-Transfer-Encoding: quoted-printable

Congrates! Your job is posted on out website!  
```



Send the email notification from your `JobController` once a job has been stored:

```php
// Job Controller.php

public function store()
    {
        request()->validate([...]);

        $job = Job::create([...]);

				// Notice we pass an instance of User rather than 
				// an email address to the Mail::to method.
				// Laravel is smart enough to figure out the email 
				// for the given user.
        Mail::to($job->employer->user)->send(new JobPosted($job));

        return redirect('jobs');
    }
```

- Also, inject the Job instance to the __constructor of our Mailable

```php
// JobPosted.php

// ğŸ”¥public property $job in our Mailable 
// will be available in our view 'mail.job-posted'
public function __construct(public Job $job){ }
```

- For cases where you donâ€™t want to expose all properties of your Job instance, you could do:

```php
// JobPosted.php

// Make the instance something other than public
public function __construct(protected Job $job){ }

public function content(): Content
    {
        return new Content(
            view: 'mail.job-posted',
            with: [
                'title' => $this->job->title, // Only title will be available inside the view
            ]
        );
    }
```

- Finally, update your view to include job details and a link

```
// job-posted.blade.php

<h2>
    {{ $job->title }}
</h2>
<p>
    Congrats! Your job is now live on our website.
</p>

<p>
    <a href="{{ url('/jobs/' . $job->id) }}">View Your Job Listing</a>
</p>
```



#### 2. Queue

S

#### 3. Build









## å…¶ä»–

#### å®‰å…¨ç™»å‡º

```html
<form method="POST" action="LOGOUT_ENDPOINT_OF_TARGET_WEBSITE">
    <button type="SUBMIT">Log Out</form>
</form>
```

